import { hilog } from '@kit.PerformanceAnalysisKit';
import videoStreamNapi from 'libentry.so';

const DOMAIN = 0x0000;

// å®šä¹‰æŽ¥å£
interface StreamInfo {
  url: string;
  isStreaming: boolean;
  info: string;
}

@Entry
@Component
struct Index {
  @State streamUrl: string = 'rtsp://77.110.228.219/axis-media/media.amp';
  @State isStreaming: boolean = false;
  @State streamInfo: string = 'No stream';
  @State logs: string[] = [];
  @State frameCount: number = 0;
  @State frameRate: number = 0;

  addLog(message: string): void {
    const timestamp = new Date().toLocaleTimeString();
    this.logs.unshift(`[${timestamp}] ${message}`);
    if (this.logs.length > 10) {
      this.logs = this.logs.slice(0, 10);
    }
    hilog.info(DOMAIN, 'VideoStream', message);
  }

  startStream(): void {
    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    this.addLog(`å‡†å¤‡å¼€å§‹æ’­æ”¾æµ: ${this.streamUrl}`);

    try {
      this.addLog('è°ƒç”¨NAPI startVideoStream...');
      const result = videoStreamNapi.startVideoStream(this.streamUrl);
      this.addLog(`NAPIè°ƒç”¨ç»“æžœ: success=${result.success}, url=${result.url}`);

      if (result.success) {
        this.isStreaming = true;
        this.addLog(`æµå¯åŠ¨æˆåŠŸ: ${this.streamUrl}`);
        this.checkStreamStatus();
      } else {
        this.addLog(`å¯åŠ¨æµå¤±è´¥: ${this.streamUrl}`);
      }
    } catch (error) {
      this.addLog(`å¯åŠ¨æµå¼‚å¸¸: ${error}`);
    }
  }

  stopStream(): void {
    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    try {
      const result = videoStreamNapi.stopVideoStream(this.streamUrl);
      if (result) {
        this.isStreaming = false;
        this.streamInfo = 'Stream stopped';
        this.frameCount = 0;
        this.frameRate = 0;
        this.addLog(`åœæ­¢æ’­æ”¾æµ: ${this.streamUrl}`);
      } else {
        this.addLog(`åœæ­¢æµå¤±è´¥: ${this.streamUrl}`);
      }
    } catch (error) {
      this.addLog(`åœæ­¢æµå¼‚å¸¸: ${error}`);
    }
  }

  checkStreamStatus(): void {
    if (!this.streamUrl.trim()) return;

    try {
      const status = videoStreamNapi.getStreamStatus(this.streamUrl);
      this.isStreaming = status.isStreaming;
      this.streamInfo = status.info;

      // èŽ·å–çœŸå®žçš„å¸§ç»Ÿè®¡ä¿¡æ¯
      if (this.isStreaming) {
        const frameStats = videoStreamNapi.getFrameStats(this.streamUrl);
        this.frameCount = frameStats.frameCount;
        this.frameRate = frameStats.frameRate;

        // å¦‚æžœè¿˜åœ¨æ’­æ”¾ï¼Œ3ç§’åŽå†æ¬¡æ£€æŸ¥
        setTimeout((): void => {
          this.checkStreamStatus();
        }, 3000);
      }
    } catch (error) {
      this.addLog(`æ£€æŸ¥æµçŠ¶æ€å¼‚å¸¸: ${error}`);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('å®žæ—¶è§†é¢‘ç›´æ’­åº”ç”¨')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(60)
      .backgroundColor('#1f2937')
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column() {
          // æµåœ°å€è¾“å…¥åŒºåŸŸ
          Column() {
            Text('æµåœ°å€è®¾ç½®')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            TextInput({
              placeholder: 'è¯·è¾“å…¥RTSP/RTP/RTMPæµåœ°å€',
              text: this.streamUrl
            })
              .width('100%')
              .height(40)
              .fontSize(14)
              .backgroundColor('#f8f9fa')
              .borderRadius(8)
              .border({ width: 1, color: '#d1d5db' })
              .padding({ left: 12, right: 12 })
              .focusable(true)
              .onChange((value: string) => {
                this.streamUrl = value;
              })
              .onFocus(() => {
                // èŽ·å¾—ç„¦ç‚¹æ—¶é€‰ä¸­å…¨éƒ¨æ–‡æœ¬ï¼ˆå¦‚æžœæ”¯æŒçš„è¯ï¼‰
              })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

          // æŽ§åˆ¶æŒ‰é’®
          Row() {
            Button('å¼€å§‹æ’­æ”¾')
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.isStreaming ? '#9ca3af' : '#10b981')
              .fontColor(Color.White)
              .enabled(!this.isStreaming)
              .onClick(() => this.startStream())

            Button('åœæ­¢æ’­æ”¾')
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.isStreaming ? '#ef4444' : '#9ca3af')
              .fontColor(Color.White)
              .enabled(this.isStreaming)
              .onClick(() => this.stopStream())
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 15, right: 15 })
          .margin({ bottom: 15 })

          // è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ
          Column() {
            Text('è§†é¢‘æ˜¾ç¤º')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            Stack() {
              // è§†é¢‘æ¸²æŸ“ç»„ä»¶
              // XComponent({
              //   id: 'videoCanvas',
              //   type: 'surface',
              //   libraryname: 'entry'
              // })
              //   .width('100%')
              //   .height(200)
              //   .backgroundColor('#000000')
              //   .borderRadius(8)
              //   .onLoad((event) => {
              //     this.addLog('è§†é¢‘ç”»å¸ƒåŠ è½½å®Œæˆ');
              //   })
              //   .onDestroy(() => {
              //     this.addLog('è§†é¢‘ç”»å¸ƒé”€æ¯');
              //   })

              // æ’­æ”¾çŠ¶æ€æŒ‡ç¤º
              Column() {
                if (this.isStreaming) {
                  Text('ðŸ”´ LIVE')
                    .fontSize(16)
                    .fontColor('#ef4444')
                    .fontWeight(FontWeight.Bold)

                  Text(`å¸§æ•°: ${this.frameCount}`)
                    .fontSize(12)
                    .fontColor('#d1d5db')
                    .margin({ top: 3 })

                  Text(`å¸§çŽ‡: ${this.frameRate.toFixed(1)} fps`)
                    .fontSize(12)
                    .fontColor('#d1d5db')
                    .margin({ top: 2 })
                } else {
                  Text('â¸ï¸ æœªæ’­æ”¾')
                    .fontSize(16)
                    .fontColor('#9ca3af')
                }

                Text(this.streamInfo)
                  .fontSize(12)
                  .fontColor('#d1d5db')
                  .margin({ top: 5 })
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .alignItems(HorizontalAlign.Center)
            }
            .alignContent(Alignment.Center)
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

          // æ—¥å¿—åŒºåŸŸ
          Column() {
            Text('è¿è¡Œæ—¥å¿—')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            Scroll() {
              Column() {
                if (this.logs.length > 0) {
                  ForEach(this.logs, (log: string) => {
                    Text(log)
                      .fontSize(12)
                      .fontColor('#374151')
                      .alignSelf(ItemAlign.Start)
                      .width('100%')
                      .padding({ top: 2, bottom: 2 })
                  })
                } else {
                  Text('æš‚æ— æ—¥å¿—')
                    .fontSize(12)
                    .fontColor('#9ca3af')
                    .textAlign(TextAlign.Center)
                    .width('100%')
                    .padding(10)
                }
              }
              .width('100%')
            }
            .width('100%')
            .height(150)
            .backgroundColor('#f9fafb')
            .borderRadius(6)
            .padding(10)
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })
        }
        .width('100%')
        .padding(15)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f3f4f6')
    }
    .width('100%')
    .height('100%')
  }
}
