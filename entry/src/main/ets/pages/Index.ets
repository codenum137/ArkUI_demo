import { hilog } from '@kit.PerformanceAnalysisKit';
import videoStreamNapi from 'libentry.so';

const DOMAIN = 0x0000;

// å®šä¹‰æ¥å£
interface StreamInfo {
  url: string;
  isStreaming: boolean;
  info: string;
}

class MyXComponentController extends XComponentController{
  private parentComponent: Index | null = null;

  setParent(parent: Index) {
    this.parentComponent = parent;
  }

  onSurfaceCreated(surfaceId: string): void {
    console.log(`onSurfaceCreated surfaceId: ${surfaceId}`);
    videoStreamNapi.setSurfaceId(BigInt(surfaceId));
    if (this.parentComponent) {
      this.parentComponent.setSurfaceId(surfaceId);
    }
  }
  onSurfaceChanged(surfaceId: string, rect: SurfaceRect): void {
    console.log(`onSurfaceChanged surfaceId: ${surfaceId}, rect: ${JSON.stringify(rect)}}`);
    videoStreamNapi.changeSurface(BigInt(surfaceId), rect.surfaceWidth, rect.surfaceHeight);
  }
  onSurfaceDestroyed(surfaceId: string): void {
    console.log(`onSurfaceDestroyed surfaceId: ${surfaceId}`);
    videoStreamNapi.destroySurface(BigInt(surfaceId));
    if (this.parentComponent) {
      this.parentComponent.setSurfaceId('');
    }
  }
}

@Entry
@Component
struct Index {
  // @State streamUrl: string = 'rtsp://77.110.228.219/axis-media/media.amp';
  @State streamUrl: string ='rtsp://10.129.177.159:8554/mystream';
  @State isStreaming: boolean = false;
  @State streamInfo: string = 'No stream';
  @State frameCount: number = 0;
  @State frameRate: number = 0;
  @State surfaceId: string = '';
  xComponentController: MyXComponentController = new MyXComponentController();

  aboutToAppear(): void {
    this.xComponentController.setParent(this);
  }

  setSurfaceId(id: string): void {
    this.surfaceId = id;
    console.log(`Surface ID updated: ${id}`);
  }

  addLog(message: string): void {
    // ç®€åŒ–ä¸ºåªè¾“å‡ºconsoleæ—¥å¿—
    console.log(`[VideoStream] ${message}`);
    hilog.info(DOMAIN, 'VideoStream', message);
  }

  startStream(): void {
    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    if (!this.surfaceId) {
      this.addLog('Surfaceæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨åé‡è¯•');
      return;
    }

    this.addLog(`å‡†å¤‡å¼€å§‹æ’­æ”¾æµ: ${this.streamUrl}`);

    try {
      this.addLog('è°ƒç”¨NAPI startVideoStream...');
      const result = videoStreamNapi.startVideoStream(this.streamUrl, BigInt(this.surfaceId));
      this.addLog(`NAPIè°ƒç”¨ç»“æœ: success=${result.success}, url=${result.url}`);

      if (result.success) {
        this.addLog(`æµå¯åŠ¨æˆåŠŸ: ${this.streamUrl}`);
        // å»¶è¿Ÿ1ç§’åå¼€å§‹æ£€æŸ¥çŠ¶æ€ï¼Œè®©C++ç«¯æœ‰æ—¶é—´å»ºç«‹è¿æ¥
        setTimeout(() => {
          this.checkStreamStatus();
        }, 1000);
      } else {
        this.addLog(`å¯åŠ¨æµå¤±è´¥: ${this.streamUrl}`);
      }
    } catch (error) {
      this.addLog(`å¯åŠ¨æµå¼‚å¸¸: ${error}`);
    }
  }

  stopStream(): void {
    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    try {
      const result = videoStreamNapi.stopVideoStream(this.streamUrl);
      if (result) {
        this.isStreaming = false;
        this.streamInfo = 'Stream stopped';
        this.frameCount = 0;
        this.frameRate = 0;
        this.addLog(`åœæ­¢æ’­æ”¾æµ: ${this.streamUrl}`);
      } else {
        this.addLog(`åœæ­¢æµå¤±è´¥: ${this.streamUrl}`);
      }
    } catch (error) {
      this.addLog(`åœæ­¢æµå¼‚å¸¸: ${error}`);
    }
  }

  checkStreamStatus(): void {
    if (!this.streamUrl.trim()) return;

    try {
      const status = videoStreamNapi.getStreamStatus(this.streamUrl);
      this.addLog(`çŠ¶æ€æ£€æŸ¥: isStreaming=${status.isStreaming}, info=${status.info}`);
      
      this.isStreaming = status.isStreaming;
      this.streamInfo = status.info;

      // è·å–çœŸå®çš„å¸§ç»Ÿè®¡ä¿¡æ¯
      if (this.isStreaming) {
        const frameStats = videoStreamNapi.getFrameStats(this.streamUrl);
        this.frameCount = frameStats.frameCount;
        this.frameRate = frameStats.frameRate;
        this.addLog(`å¸§ç»Ÿè®¡: count=${this.frameCount}, rate=${this.frameRate.toFixed(1)}fps`);

        // å¦‚æœè¿˜åœ¨æ’­æ”¾ï¼Œ3ç§’åå†æ¬¡æ£€æŸ¥
        setTimeout((): void => {
          this.checkStreamStatus();
        }, 3000);
      } else {
        this.addLog('æµæœªåœ¨æ’­æ”¾çŠ¶æ€');
      }
    } catch (error) {
      this.addLog(`æ£€æŸ¥æµçŠ¶æ€å¼‚å¸¸: ${error}`);
    }
  }

  renderTestFrame(r: number, g: number, b: number, a: number): void {
    if (!this.surfaceId) {
      this.addLog('Surfaceæœªå‡†å¤‡å¥½ï¼Œæ— æ³•æ¸²æŸ“æµ‹è¯•å¸§');
      return;
    }

    this.addLog(`æ¸²æŸ“æµ‹è¯•å¸§: é¢œè‰²(${r}, ${g}, ${b}, ${a})`);

    try {
      const result = videoStreamNapi.renderSingleTestFrame(BigInt(this.surfaceId), r, g, b, a);
      this.addLog(`æµ‹è¯•å¸§æ¸²æŸ“ç»“æœ: ${result ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
    } catch (error) {
      this.addLog(`æ¸²æŸ“æµ‹è¯•å¸§å¼‚å¸¸: ${error}`);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('å®æ—¶è§†é¢‘ç›´æ’­åº”ç”¨')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(60)
      .backgroundColor('#1f2937')
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column() {
          // æµåœ°å€è¾“å…¥åŒºåŸŸ
          Column() {
            Text('æµåœ°å€è®¾ç½®')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            TextInput({
              placeholder: 'è¯·è¾“å…¥RTSP/RTP/RTMPæµåœ°å€',
              text: this.streamUrl
            })
              .width('100%')
              .height(40)
              .fontSize(14)
              .backgroundColor('#f8f9fa')
              .borderRadius(8)
              .border({ width: 1, color: '#d1d5db' })
              .padding({ left: 12, right: 12 })
              .focusable(true)
              .onChange((value: string) => {
                this.streamUrl = value;
              })
              .onFocus(() => {
                // è·å¾—ç„¦ç‚¹æ—¶é€‰ä¸­å…¨éƒ¨æ–‡æœ¬ï¼ˆå¦‚æœæ”¯æŒçš„è¯ï¼‰
              })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

          // æ§åˆ¶æŒ‰é’®
          Row() {
            Button('å¼€å§‹æ’­æ”¾')
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.isStreaming ? '#9ca3af' : (!this.surfaceId ? '#f59e0b' : '#10b981'))
              .fontColor(Color.White)
              .enabled(!this.isStreaming && !!this.surfaceId)
              .onClick(() => this.startStream())

            Button('åœæ­¢æ’­æ”¾')
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.isStreaming ? '#ef4444' : '#9ca3af')
              .fontColor(Color.White)
              .enabled(this.isStreaming)
              .onClick(() => this.stopStream())
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 15, right: 15 })
          .margin({ bottom: 15 })

          // æµ‹è¯•æŒ‰é’®åŒºåŸŸ
          Column() {
            Text('æ¸²æŸ“æµ‹è¯•')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            Row() {
              Button('è“è‰²æµ‹è¯•å¸§')
                .width('30%')
                .height(35)
                .fontSize(14)
                .backgroundColor('#3b82f6')
                .fontColor(Color.White)
                .enabled(!!this.surfaceId)
                .onClick(() => this.renderTestFrame(0.2, 0.6, 0.9, 1.0))

              Button('çº¢è‰²æµ‹è¯•å¸§')
                .width('30%')
                .height(35)
                .fontSize(14)
                .backgroundColor('#ef4444')
                .fontColor(Color.White)
                .enabled(!!this.surfaceId)
                .onClick(() => this.renderTestFrame(0.9, 0.2, 0.2, 1.0))

              Button('ç»¿è‰²æµ‹è¯•å¸§')
                .width('30%')
                .height(35)
                .fontSize(14)
                .backgroundColor('#10b981')
                .fontColor(Color.White)
                .enabled(!!this.surfaceId)
                .onClick(() => this.renderTestFrame(0.2, 0.9, 0.2, 1.0))
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

          // è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ
          Column() {
            Row() {
              Text('è§†é¢‘æ˜¾ç¤º')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .layoutWeight(1)

              Text(this.surfaceId ? `Surface: ${this.surfaceId.substring(0, 8)}...` : 'Surface: æœªåˆå§‹åŒ–')
                .fontSize(12)
                .fontColor(this.surfaceId ? '#10b981' : '#ef4444')
            }
            .width('100%')
            .margin({ bottom: 10 })

            // è§†é¢‘æ¸²æŸ“ç»„ä»¶XComponent
            XComponent({
              type: XComponentType.SURFACE,
              controller: this.xComponentController
            })
              .width('100%')
              .height(200)
              .backgroundColor('#000000')
              .borderRadius(8)

            // æ’­æ”¾çŠ¶æ€æŒ‡ç¤º - ç§»åˆ°è§†é¢‘ä¸‹æ–¹
            Row() {
              if (this.isStreaming) {
                Text('ğŸ”´ LIVE')
                  .fontSize(14)
                  .fontColor('#ef4444')
                  .fontWeight(FontWeight.Bold)

                Text(`å¸§æ•°: ${this.frameCount}`)
                  .fontSize(12)
                  .fontColor('#6b7280')
                  .margin({ left: 15 })

                Text(`å¸§ç‡: ${this.frameRate.toFixed(1)} fps`)
                  .fontSize(12)
                  .fontColor('#6b7280')
                  .margin({ left: 10 })
              } else {
                Text('â¸ï¸ æœªæ’­æ”¾')
                  .fontSize(14)
                  .fontColor('#9ca3af')
              }
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .alignItems(VerticalAlign.Center)
            .margin({ top: 8 })

            // æµä¿¡æ¯æ˜¾ç¤º
            if (this.streamInfo && this.streamInfo !== 'No stream') {
              Text(this.streamInfo)
                .fontSize(11)
                .fontColor('#9ca3af')
                .margin({ top: 4 })
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('100%')
            }
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

        }
        .width('100%')
        .padding(15)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f3f4f6')
    }
    .width('100%')
    .height('100%')
  }
}
