import { hilog } from '@kit.PerformanceAnalysisKit';
import videoStreamNapi from 'libentry.so';

const DOMAIN = 0x0000;

// å®šä¹‰æ¥å£
interface StreamInfo {
  url: string;
  isStreaming: boolean;
  info: string;
}

// è§†é¢‘æµçŠ¶æ€æœºæšä¸¾
enum StreamState {
  IDLE = 'idle',           // ç©ºé—²çŠ¶æ€
  STARTING = 'starting',   // å¯åŠ¨ä¸­
  RUNNING = 'running',     // è¿è¡Œä¸­
  STOPPING = 'stopping',   // ç»“æŸä¸­
  ERROR = 'error'          // é”™è¯¯çŠ¶æ€
}

class MyXComponentController extends XComponentController{
  private parentComponent: Index | null = null;

  setParent(parent: Index) {
    this.parentComponent = parent;
  }

  onSurfaceCreated = (surfaceId: string): void => {
    console.log(`onSurfaceCreated surfaceId: ${surfaceId}`);
    videoStreamNapi.setSurfaceId(BigInt(surfaceId));
    if (this.parentComponent) {
      this.parentComponent.setSurfaceId(surfaceId);
    }
  }
  onSurfaceChanged = (surfaceId: string, rect: SurfaceRect): void => {
    console.log(`onSurfaceChanged surfaceId: ${surfaceId}, rect: ${JSON.stringify(rect)}}`);
    videoStreamNapi.changeSurface(BigInt(surfaceId), rect.surfaceWidth, rect.surfaceHeight);
  }
  onSurfaceDestroyed = (surfaceId: string): void => {
    console.log(`onSurfaceDestroyed surfaceId: ${surfaceId}`);
    videoStreamNapi.destroySurface(BigInt(surfaceId));
    if (this.parentComponent) {
      this.parentComponent.setSurfaceId('');
    }
  }
}

@Entry
@Component
struct Index {
  // @State streamUrl: string = 'rtsp://10.129.177.159:8554/mystream'; //hey
  @State streamUrl: string = 'rtsp://10.29.237.55:8554/live';
  // @State streamUrl: string ='rtsp://localhost:8554/live';
  @State isStreaming: boolean = false;
  @State streamInfo: string = 'No stream';
  @State frameCount: number = 0;
  @State frameRate: number = 0;
  @State surfaceId: string = '';
  
  // çŠ¶æ€æœºç›¸å…³
  @State currentState: StreamState = StreamState.IDLE;
  @State stateMessage: string = 'å‡†å¤‡å°±ç»ª';
  
  xComponentController: MyXComponentController = new MyXComponentController();
  private statusTimer: number = -1;
  private stateTransitionTimer: number = -1;

  aboutToAppear(): void {
    this.xComponentController.setParent(this);
    this.transitionToState(StreamState.IDLE, 'ç­‰å¾…ç”¨æˆ·æ“ä½œ');
  }

  aboutToDisappear(): void {
    // ç»„ä»¶é”€æ¯æ—¶å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æº
    this.forceCleanup();
  }

  setSurfaceId(id: string): void {
    this.surfaceId = id;
    console.log(`Surface ID updated: ${id}`);
  }

  addLog(message: string): void {
    const stateInfo = `[${this.currentState}] ${message}`;
    console.log(`[VideoStream] ${stateInfo}`);
    hilog.info(DOMAIN, 'VideoStream', stateInfo);
  }

  // çŠ¶æ€æœºæ ¸å¿ƒæ–¹æ³•
  transitionToState(newState: StreamState, message?: string): void {
    const oldState = this.currentState;
    this.currentState = newState;
    this.stateMessage = message || this.getStateDescription(newState);
    
    this.addLog(`çŠ¶æ€è½¬æ¢: ${oldState} -> ${newState} (${this.stateMessage})`);
    
    // æ ¹æ®æ–°çŠ¶æ€æ‰§è¡Œç›¸åº”åŠ¨ä½œ
    this.executeStateAction(newState);
  }

  getStateDescription(state: StreamState): string {
    switch (state) {
      case StreamState.IDLE: return 'ç©ºé—²çŠ¶æ€';
      case StreamState.STARTING: return 'æ­£åœ¨å¯åŠ¨...';
      case StreamState.RUNNING: return 'æ’­æ”¾ä¸­';
      case StreamState.STOPPING: return 'æ­£åœ¨ç»“æŸ...';
      case StreamState.ERROR: return 'å‘ç”Ÿé”™è¯¯';
      default: return 'æœªçŸ¥çŠ¶æ€';
    }
  }

  executeStateAction(state: StreamState): void {
    // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€è½¬æ¢å®šæ—¶å™¨
    if (this.stateTransitionTimer !== -1) {
      clearTimeout(this.stateTransitionTimer);
      this.stateTransitionTimer = -1;
    }

    switch (state) {
      case StreamState.IDLE:
        this.isStreaming = false;
        this.frameCount = 0;
        this.frameRate = 0;
        this.streamInfo = 'No stream';
        this.stopStatusPolling();
        break;
        
      case StreamState.STARTING:
        this.performStart();
        break;
        
      case StreamState.RUNNING:
        this.isStreaming = true;
        this.startStatusPolling();
        break;
        
      case StreamState.STOPPING:
        this.performStop();
        break;
        
      case StreamState.ERROR:
        this.isStreaming = false;
        this.stopStatusPolling();
        // é”™è¯¯çŠ¶æ€5ç§’åè‡ªåŠ¨å›åˆ°IDLE
        this.stateTransitionTimer = setTimeout(() => {
          this.transitionToState(StreamState.IDLE, 'é”™è¯¯æ¢å¤');
        }, 5000);
        break;
    }
  }

  // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦å…è®¸
  canTransitionTo(targetState: StreamState): boolean {
    const transitions: Record<StreamState, StreamState[]> = {
      [StreamState.IDLE]: [StreamState.STARTING],
      [StreamState.STARTING]: [StreamState.RUNNING, StreamState.ERROR, StreamState.IDLE],
      [StreamState.RUNNING]: [StreamState.STOPPING, StreamState.ERROR],
      [StreamState.STOPPING]: [StreamState.IDLE, StreamState.ERROR],
      [StreamState.ERROR]: [StreamState.IDLE]
    };
    
    return transitions[this.currentState]?.includes(targetState) || false;
  }

  startStream(): void {
    if (!this.canTransitionTo(StreamState.STARTING)) {
      this.addLog(`å½“å‰çŠ¶æ€ ${this.currentState} ä¸å…è®¸å¯åŠ¨æµ`);
      return;
    }

    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    if (!this.surfaceId) {
      this.addLog('Surfaceæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨åé‡è¯•');
      return;
    }

    this.transitionToState(StreamState.STARTING, `å‡†å¤‡å¯åŠ¨æµ: ${this.streamUrl}`);
  }

  performStart(): void {
    try {
      this.addLog('è°ƒç”¨NAPI startVideoStream...');
      const result = videoStreamNapi.startVideoStream(this.streamUrl, BigInt(this.surfaceId));
      this.addLog(`NAPIè°ƒç”¨ç»“æœ: success=${result.success}, url=${result.url}`);

      if (result.success) {
        // å¯åŠ¨æˆåŠŸï¼Œä½†éœ€è¦ç­‰å¾…å®é™…è¿æ¥å»ºç«‹
        this.stateTransitionTimer = setTimeout(() => {
          this.transitionToState(StreamState.RUNNING, 'æµå¯åŠ¨æˆåŠŸ');
        }, 5000);
      } else {
        this.transitionToState(StreamState.ERROR, 'å¯åŠ¨æµå¤±è´¥');
      }
    } catch (error) {
      this.addLog(`å¯åŠ¨æµå¼‚å¸¸: ${error}`);
      this.transitionToState(StreamState.ERROR, `å¯åŠ¨å¼‚å¸¸: ${error}`);
    }
  }

  stopStream(): void {
    if (!this.canTransitionTo(StreamState.STOPPING)) {
      this.addLog(`å½“å‰çŠ¶æ€ ${this.currentState} ä¸å…è®¸ç»“æŸæµ`);
      return;
    }

    if (!this.streamUrl.trim()) {
      this.addLog('è¯·è¾“å…¥æµåœ°å€');
      return;
    }

    this.transitionToState(StreamState.STOPPING, `å‡†å¤‡ç»“æŸæµ: ${this.streamUrl}`);
  }

  performStop(): void {
    try {
      const result = videoStreamNapi.stopVideoStream(this.streamUrl);
      if (result) {
        this.addLog(`ç»“æŸæ’­æ”¾æµæˆåŠŸ: ${this.streamUrl}`);
        // ç»™C++å±‚å……åˆ†æ—¶é—´æ¸…ç†èµ„æº
        this.stateTransitionTimer = setTimeout(() => {
          this.transitionToState(StreamState.IDLE, 'æµå·²ç»“æŸ');
        }, 2000);
      } else {
        this.transitionToState(StreamState.ERROR, 'ç»“æŸæµå¤±è´¥');
      }
    } catch (error) {
      this.addLog(`ç»“æŸæµå¼‚å¸¸: ${error}`);
      this.transitionToState(StreamState.ERROR, `ç»“æŸå¼‚å¸¸: ${error}`);
    }
  }

  forceCleanup(): void {
    this.addLog('æ‰§è¡Œå¼ºåˆ¶æ¸…ç†...');
    this.stopStatusPolling();
    
    if (this.stateTransitionTimer !== -1) {
      clearTimeout(this.stateTransitionTimer);
      this.stateTransitionTimer = -1;
    }

    try {
      if (this.streamUrl.trim()) {
        // ç½‘ç»œèµ„æºå¯¹ç§°æ¸…ç†ï¼šç¡®ä¿C++å±‚å®Œæˆç½‘ç»œèµ„æºæ¸…ç†
        this.addLog('æ­£åœ¨æ¸…ç†ç½‘ç»œèµ„æº...');
        const result = videoStreamNapi.stopVideoStream(this.streamUrl);
        this.addLog(`ç½‘ç»œèµ„æºæ¸…ç†ç»“æœ: ${result}`);
        
        // ç»™C++å±‚æ›´å¤šæ—¶é—´è¿›è¡Œç½‘ç»œæ¸…ç†
        setTimeout(() => {
          this.addLog('ç½‘ç»œèµ„æºæ¸…ç†å®Œæˆ');
        }, 1000);
      }
    } catch (error) {
      this.addLog(`å¼ºåˆ¶æ¸…ç†å¼‚å¸¸: ${error}`);
    }
    
    this.transitionToState(StreamState.IDLE, 'å¼ºåˆ¶æ¸…ç†å®Œæˆ');
  }

  // UIçŠ¶æ€æ§åˆ¶æ–¹æ³•
  canStartStream(): boolean {
    return this.currentState === StreamState.IDLE && !!this.surfaceId;
  }

  canStopStream(): boolean {
    return this.currentState === StreamState.RUNNING || this.currentState === StreamState.STARTING;
  }

  getStartButtonText(): string {
    switch (this.currentState) {
      case StreamState.STARTING: return 'å¯åŠ¨ä¸­...';
      case StreamState.RUNNING: return 'æ’­æ”¾ä¸­';
      case StreamState.STOPPING: return 'ç»“æŸä¸­...';
      default: return 'å¼€å§‹æ’­æ”¾';
    }
  }

  getStopButtonText(): string {
    switch (this.currentState) {
      case StreamState.STOPPING: return 'ç»“æŸä¸­...';
      case StreamState.STARTING: return 'å–æ¶ˆå¯åŠ¨';
      default: return 'ç»“æŸæ’­æ”¾';
    }
  }

  getStartButtonColor(): string {
    if (!this.surfaceId) return '#f59e0b'; // æ©™è‰²ï¼šSurfaceæœªå‡†å¤‡
    if (this.currentState === StreamState.IDLE) return '#10b981'; // ç»¿è‰²ï¼šå¯ä»¥å¯åŠ¨
    return '#9ca3af'; // ç°è‰²ï¼šä¸å¯æ“ä½œ
  }

  getStopButtonColor(): string {
    if (this.currentState === StreamState.RUNNING || this.currentState === StreamState.STARTING) {
      return '#ef4444'; // çº¢è‰²ï¼šå¯ä»¥ç»“æŸ
    }
    return '#9ca3af'; // ç°è‰²ï¼šä¸å¯æ“ä½œ
  }

  getStateColor(): string {
    switch (this.currentState) {
      case StreamState.IDLE: return '#6b7280';
      case StreamState.STARTING: return '#f59e0b';
      case StreamState.RUNNING: return '#10b981';
      case StreamState.STOPPING: return '#f59e0b';
      case StreamState.ERROR: return '#ef4444';
      default: return '#6b7280';
    }
  }

  startStatusPolling(): void {
    this.stopStatusPolling(); // å…ˆæ¸…é™¤æ—§çš„è®¡æ—¶å™¨ï¼Œä»¥é˜²ä¸‡ä¸€
    // å»¶è¿Ÿ1ç§’åå¼€å§‹ï¼Œè®©C++ç«¯æœ‰æ—¶é—´å»ºç«‹è¿æ¥
    setTimeout(() => {
      this.checkStreamStatus(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      // ç„¶åè®¾ç½®å®šæ—¶å™¨ï¼Œä»¥3ç§’ä¸ºé—´éš”é‡å¤æ‰§è¡Œ
      this.statusTimer = setInterval(() => {
        this.checkStreamStatus();
      }, 3000);
    }, 1000);
  }

  stopStatusPolling(): void {
    if (this.statusTimer !== -1) {
      clearInterval(this.statusTimer);
      this.statusTimer = -1;
      this.addLog('çŠ¶æ€æ£€æŸ¥è®¡æ—¶å™¨å·²åœæ­¢');
    }
  }

  checkStreamStatus(): void {
    if (!this.streamUrl.trim()) {
      this.stopStatusPolling();
      return;
    }

    // åªåœ¨RUNNINGçŠ¶æ€æˆ–STARTINGçŠ¶æ€æ£€æŸ¥
    if (this.currentState !== StreamState.RUNNING && this.currentState !== StreamState.STARTING) {
      return;
    }

    try {
      const status = videoStreamNapi.getStreamStatus(this.streamUrl);
      this.addLog(`çŠ¶æ€æ£€æŸ¥: isStreaming=${status.isStreaming}, info=${status.info}`);

      // æ ¹æ®å®é™…æµçŠ¶æ€å’Œå½“å‰çŠ¶æ€æœºçŠ¶æ€è¿›è¡Œå¤„ç†
      if (status.isStreaming) {
        // æµæ­£åœ¨è¿è¡Œ
        if (this.currentState === StreamState.STARTING) {
          // ä»å¯åŠ¨çŠ¶æ€è½¬ä¸ºè¿è¡ŒçŠ¶æ€
          this.transitionToState(StreamState.RUNNING, 'æµè¿æ¥å·²å»ºç«‹');
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        this.streamInfo = status.info;
        const frameStats = videoStreamNapi.getFrameStats(this.streamUrl);
        this.frameCount = frameStats.frameCount;
        this.frameRate = frameStats.frameRate;
        this.addLog(`å¸§ç»Ÿè®¡: count=${this.frameCount}, rate=${this.frameRate.toFixed(1)}fps`);
      } else {
        // æµæœªè¿è¡Œ
        if (this.currentState === StreamState.RUNNING) {
          // è¿è¡Œä¸­ä½†æ£€æµ‹åˆ°æµæ–­å¼€
          this.transitionToState(StreamState.ERROR, 'æµè¿æ¥å·²æ–­å¼€');
        } else if (this.currentState === StreamState.STARTING) {
          // ä»åœ¨è¿æ¥ä¸­ï¼Œæ›´æ–°ä¿¡æ¯ä½†ä¸æ”¹å˜çŠ¶æ€
          this.streamInfo = status.info || 'æ­£åœ¨å»ºç«‹è¿æ¥...';
        }
      }
    } catch (error) {
      this.addLog(`æ£€æŸ¥æµçŠ¶æ€å¼‚å¸¸: ${error}`);
      if (this.currentState === StreamState.RUNNING || this.currentState === StreamState.STARTING) {
        this.transitionToState(StreamState.ERROR, `çŠ¶æ€æ£€æŸ¥å¼‚å¸¸: ${error}`);
      }
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('å®æ—¶è§†é¢‘ç›´æ’­åº”ç”¨')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(60)
      .backgroundColor('#1f2937')
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column() {
          // æµåœ°å€è¾“å…¥åŒºåŸŸ
          Column() {
            Text('æµåœ°å€è®¾ç½®')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 10 })

            TextInput({
              placeholder: 'è¯·è¾“å…¥RTSP/RTP/RTMPæµåœ°å€',
              text: this.streamUrl
            })
              .width('100%')
              .height(40)
              .fontSize(14)
              .backgroundColor('#f8f9fa')
              .borderRadius(8)
              .border({ width: 1, color: '#d1d5db' })
              .padding({ left: 12, right: 12 })
              .focusable(true)
              .onChange((value: string) => {
                this.streamUrl = value;
              })
              .onFocus(() => {
                // è·å¾—ç„¦ç‚¹æ—¶é€‰ä¸­å…¨éƒ¨æ–‡æœ¬ï¼ˆå¦‚æœæ”¯æŒçš„è¯ï¼‰
              })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

          // æ§åˆ¶æŒ‰é’®
          Row() {
            Button(this.getStartButtonText())
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.getStartButtonColor())
              .fontColor(Color.White)
              .enabled(this.canStartStream())
              .onClick(() => this.startStream())

            Button(this.getStopButtonText())
              .width('48%')
              .height(40)
              .fontSize(16)
              .backgroundColor(this.getStopButtonColor())
              .fontColor(Color.White)
              .enabled(this.canStopStream())
              .onClick(() => this.stopStream())
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 15, right: 15 })
          .margin({ bottom: 15 })

          // è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ
          Column() {
            Row() {
              Text('è§†é¢‘æ˜¾ç¤º')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .layoutWeight(1)

              Column() {
                Text(this.surfaceId ? `Surface: ${this.surfaceId.substring(0, 8)}...` : 'Surface: æœªåˆå§‹åŒ–')
                  .fontSize(12)
                  .fontColor(this.surfaceId ? '#10b981' : '#ef4444')
                
                Text(`çŠ¶æ€: ${this.stateMessage}`)
                  .fontSize(11)
                  .fontColor(this.getStateColor())
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.End)
            }
            .width('100%')
            .margin({ bottom: 10 })

            // è§†é¢‘æ¸²æŸ“ç»„ä»¶XComponent
            XComponent({
              type: XComponentType.SURFACE,
              controller: this.xComponentController
            })
              .width('100%')
              .height(200)
              .backgroundColor('#000000')
              .borderRadius(8)

            // æ’­æ”¾çŠ¶æ€æŒ‡ç¤º - ç§»åˆ°è§†é¢‘ä¸‹æ–¹
            Row() {
              if (this.isStreaming) {
                Text('ğŸ”´ LIVE')
                  .fontSize(14)
                  .fontColor('#ef4444')
                  .fontWeight(FontWeight.Bold)

                Text(`å¸§æ•°: ${this.frameCount}`)
                  .fontSize(12)
                  .fontColor('#6b7280')
                  .margin({ left: 15 })

                Text(`å¸§ç‡: ${this.frameRate.toFixed(1)} fps`)
                  .fontSize(12)
                  .fontColor('#6b7280')
                  .margin({ left: 10 })
              } else {
                Text('â¸ï¸ æœªæ’­æ”¾')
                  .fontSize(14)
                  .fontColor('#9ca3af')
              }
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .alignItems(VerticalAlign.Center)
            .margin({ top: 8 })

            // æµä¿¡æ¯æ˜¾ç¤º
            if (this.streamInfo && this.streamInfo !== 'No stream') {
              Text(this.streamInfo)
                .fontSize(11)
                .fontColor('#9ca3af')
                .margin({ top: 4 })
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('100%')
            }
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .margin({ bottom: 15 })

        }
        .width('100%')
        .padding(15)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f3f4f6')
    }
    .width('100%')
    .height('100%')
  }
}
